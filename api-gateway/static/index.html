<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-enter {
            animation: fadeIn 0.3s ease-out;
        }
        .typing-indicator span {
            animation: blink 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
        /* Markdown æ ·å¼å¾®è°ƒ */
        .markdown-body img { max-width: 100%; border-radius: 0.5rem; margin: 1rem 0; }
        .markdown-body pre { background: #1f2937; color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; }
        .markdown-body code { background: #374151; color: #e5e7eb; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.875rem; }
        .markdown-body p { margin-bottom: 0.5rem; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.5rem; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col h-screen">

    <header class="bg-white shadow-sm p-4 flex items-center justify-between z-10">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-lg flex items-center justify-center shadow-md">
                <i class="fas fa-robot text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-800 tracking-tight">Gemini Chat</h1>
            </div>
        </div>

        <div class="flex items-center space-x-2">
            <div class="relative">
                <select id="modelSelect" class="appearance-none bg-gray-50 border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent cursor-pointer">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="deepseek-r1:1.5b">DeepSeek R1</option>
                    <option value="qwen2.5:7b">Qwen 2.5</option>
                    <option value="gemini-2.5-flash, deepseek-r1:1.5b">âš¡ æ‰‡å‡ºæ¨¡å¼ (Gemini + DeepSeek)</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <i class="fas fa-chevron-down text-xs"></i>
                </div>
            </div>

            <button onclick="newChat()" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-sm text-sm font-medium">
                <i class="fas fa-plus mr-2"></i> æ–°å¯¹è¯
            </button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden relative">
        <aside id="historySidebar" class="w-80 bg-gray-50 border-r border-gray-200 flex flex-col hidden md:flex absolute left-0 top-0 bottom-0 z-20 md:static shadow-xl md:shadow-none transition-all duration-300 transform translate-x-0">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="font-semibold text-gray-700">å†å²å¯¹è¯</h2>
                <button onclick="toggleHistory()" class="md:hidden text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="historyList" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
        </aside>

        <main class="flex-1 flex flex-col bg-white relative w-full">
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 scroll-smooth">
                <div class="h-full flex flex-col items-center justify-center text-gray-400">
                    <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mb-6">
                        <i class="fas fa-comments text-4xl text-gray-300"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-600 mb-2">å¼€å§‹æ–°çš„å¯¹è¯</h2>
                    <p class="text-sm">é€‰æ‹©æ¨¡å‹ï¼Œè¾“å…¥é—®é¢˜ï¼Œä½“éªŒå¤šæ¨¡å‹å¹¶å‘å¤„ç†ã€‚</p>
                </div>
            </div>

            <div class="border-t border-gray-200 bg-gray-50 p-4">
                <div class="max-w-4xl mx-auto">
                    <div id="filePreview" class="mb-3 hidden flex flex-wrap gap-2"></div>

                    <div class="flex items-end gap-2 bg-white p-2 rounded-xl border border-gray-300 shadow-sm focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent transition-all">
                        <label class="cursor-pointer p-2 text-gray-400 hover:text-blue-500 hover:bg-gray-100 rounded-lg transition">
                            <i class="fas fa-paperclip text-lg"></i>
                            <input type="file" id="fileInput" multiple class="hidden" onchange="handleFileSelect(event)">
                        </label>

                        <textarea
                            id="messageInput"
                            rows="1"
                            class="flex-1 max-h-32 py-2 px-2 bg-transparent border-none focus:ring-0 resize-none text-gray-700 placeholder-gray-400 leading-normal"
                            placeholder="è¾“å…¥æ¶ˆæ¯... (Shift+Enter æ¢è¡Œ)"
                            oninput="autoResize(this)"
                            onkeydown="handleKeyPress(event)"
                        ></textarea>

                        <button
                            id="sendButton"
                            onclick="sendMessage()"
                            class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex-shrink-0 w-10 h-10 flex items-center justify-center"
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="text-center mt-2">
                        <p class="text-xs text-gray-400">AI å†…å®¹ç”±å¤§æ¨¡å‹ç”Ÿæˆï¼Œè¯·ä»”ç»†ç”„åˆ«ã€‚</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <footer class="bg-white border-t border-gray-200 py-1 px-4 text-xs text-gray-500 flex justify-between items-center z-10">
        <span>Powered by FastAPI & Redis Streams</span>
        <span id="statusIndicator" class="flex items-center gap-1.5">Checking...</span>
    </footer>

    <script>
        const API_BASE = window.location.origin;
        let currentConversationId = null;

        const TASK_STATUS = { PENDING: 0, SUCCESS: 1, FAILED: 2, PROCESSING: 3 };

        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            loadHistory();
        });

        function toggleHistory() {
            document.getElementById('historySidebar').classList.toggle('hidden');
        }

        // === æ¶ˆæ¯å‘é€ ===
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            const modelConfig = document.getElementById('modelSelect').value;
            const fileInput = document.getElementById('fileInput');

            if (!message && fileInput.files.length === 0) return;

            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('filePreview').innerHTML = '';
            document.getElementById('filePreview').classList.add('hidden');
            fileInput.value = '';

            addMessage('user', message);
            const loadingId = addMessage('assistant', '<div class="typing-indicator flex gap-1"><span>â—</span><span>â—</span><span>â—</span></div>', true);

            try {
                // æäº¤è¯·æ±‚
                const response = await fetch(`${API_BASE}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: message, model: modelConfig, conversation_id: currentConversationId })
                });

                if (!response.ok) throw new Error(`æäº¤å¤±è´¥: ${response.status}`);

                const data = await response.json();
                const batchId = data.batch_id;
                currentConversationId = data.conversation_id;

                // è½®è¯¢ç»“æœ (æ”¯æŒå¢é‡æ˜¾ç¤º)
                pollBatchResult(batchId, loadingId);

            } catch (error) {
                document.getElementById(loadingId).remove();
                addMessage('error', `âŒ å‘é€å¤±è´¥: ${error.message}`);
                sendButton.disabled = false;
            }
        }

        // === è½®è¯¢ç»“æœ (å¢é‡æ˜¾ç¤ºé€»è¾‘) ===
 function pollBatchResult(batchId, loadingMsgId) {
            let attempts = 0;
            const maxAttempts = 120;
            const intervalTime = 5000;
            const displayedTaskIds = new Set(); // è®°å½•å·²æ˜¾ç¤ºçš„ä»»åŠ¡

            const timer = setInterval(async () => {
                attempts++;
                try {
                    const res = await fetch(`${API_BASE}/v1/batches/${batchId}`);
                    if (!res.ok) return;

                    const batchData = await res.json();

                    // --- 1. å…ˆè®¡ç®—çŠ¶æ€ (æ˜¯å¦å…¨éƒ¨å®Œæˆ) ---
                    const finishedCount = batchData.results.filter(
                        t => t.status === TASK_STATUS.SUCCESS || t.status === TASK_STATUS.FAILED
                    ).length;

                    const isAllFinished = batchData.results.length === finishedCount;

                    // --- 2. ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå¦‚æœå®Œæˆäº†ï¼Œå…ˆæŠŠæ€è€ƒå›¾æ ‡åˆ æ‰ï¼---
                    // å¿…é¡»æ”¾åœ¨ addMessage ä¹‹å‰ï¼Œè¿™æ ·ç”¨æˆ·æ°¸è¿œä¸ä¼šçœ‹åˆ°å®ƒä»¬åŒæ—¶å­˜åœ¨
                    if (isAllFinished) {
                        clearInterval(timer); // åœæ­¢è½®è¯¢
                        const loadingEl = document.getElementById(loadingMsgId);
                        if (loadingEl) {
                            loadingEl.remove(); // ç«‹å³ç§»é™¤ DOM
                        }

                        document.getElementById('sendButton').disabled = false;
                        loadHistory(); // åˆ·æ–°ä¾§è¾¹æ 
                    }

                    // --- 3. å†æ˜¾ç¤ºæ–°æ¶ˆæ¯ ---
                    batchData.results.forEach(task => {
                        // åªæœ‰æˆåŠŸæˆ–å¤±è´¥ï¼Œä¸”ä¹‹å‰æ²¡æ˜¾ç¤ºè¿‡çš„ä»»åŠ¡æ‰å¤„ç†
                        if ((task.status === TASK_STATUS.SUCCESS || task.status === TASK_STATUS.FAILED)
                            && !displayedTaskIds.has(task.task_id)) {

                            displayedTaskIds.add(task.task_id); // æ ‡è®°å·²æ˜¾ç¤º

                            if (task.status === TASK_STATUS.SUCCESS) {
                                let content = task.response_text;
                                // å¤šæ¨¡å‹æ—¶æ˜¾ç¤ºå‰ç¼€ï¼Œå•æ¨¡å‹ä¿æŒçº¯å‡€
                                if (batchData.results.length > 1) {
                                    content = `**ğŸ¤– ${task.model_name}** (${task.cost_time}s):\n\n${content}`;
                                }
                                addMessage('assistant', content);
                            } else {
                                addMessage('error', `âŒ [${task.model_name}] ä»»åŠ¡å¤±è´¥: ${task.error_msg}`);
                            }
                        }
                    });

                    // --- 4. å¤šæ¨¡å‹ç‰¹æ®Šå¤„ç† (å¯é€‰) ---
                    // å¦‚æœè¿˜æ²¡å…¨éƒ¨å®Œæˆï¼ˆä¾‹å¦‚3ä¸ªæ¨¡å‹åªå›æ¥äº†1ä¸ªï¼‰ï¼Œä¸”æœ‰æ–°æ¶ˆæ¯
                    // æˆ‘ä»¬æ‰æŠŠæ€è€ƒå›¾æ ‡ç§»åŠ¨åˆ°æœ€ä¸‹é¢ã€‚å¦‚æœæ˜¯å•æ¨¡å‹ï¼Œæ­¥éª¤2å·²ç»æŠŠå®ƒåˆ äº†ï¼Œè¿™é‡Œä¸ä¼šæ‰§è¡Œã€‚
                    if (!isAllFinished && attempts < maxAttempts) {
                        const loadingEl = document.getElementById(loadingMsgId);
                        if (loadingEl) {
                            document.getElementById('messagesContainer').appendChild(loadingEl);
                            document.getElementById('messagesContainer').scrollTop = document.getElementById('messagesContainer').scrollHeight;
                        }
                    }

                    // --- 5. è¶…æ—¶å¤„ç† ---
                    if (attempts >= maxAttempts && !isAllFinished) {
                        clearInterval(timer);
                        const loadingEl = document.getElementById(loadingMsgId);
                        if (loadingEl) loadingEl.remove();
                        addMessage('error', 'âš ï¸ éƒ¨åˆ†ä»»åŠ¡å“åº”è¶…æ—¶ï¼Œè¯·ç¨åæŸ¥çœ‹å†å²ã€‚');
                        document.getElementById('sendButton').disabled = false;
                    }

                } catch (e) {
                    console.error("Polling error:", e);
                }
            }, intervalTime);
        }

        // === åŠ è½½å†å²åˆ—è¡¨ ===
        async function loadHistory() {
            const listContainer = document.getElementById('historyList');
            if (!listContainer.hasChildNodes()) {
                listContainer.innerHTML = '<div class="text-center text-gray-400 py-4"><i class="fas fa-spinner fa-spin"></i></div>';
            }

            try {
                const res = await fetch(`${API_BASE}/v1/conversations`);
                const data = await res.json();

                if (!data.conversations || data.conversations.length === 0) {
                    listContainer.innerHTML = '<div class="text-center text-gray-400 text-sm py-8">æš‚æ— å†å²è®°å½•</div>';
                    return;
                }

                listContainer.innerHTML = data.conversations.map(conv => `
                    <div onclick="loadConversation('${conv.conversation_id}')"
                         class="group p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-400 cursor-pointer transition relative mb-2 shadow-sm ${currentConversationId === conv.conversation_id ? 'border-blue-400 ring-1 ring-blue-100' : ''}">
                        <div class="font-medium text-gray-800 truncate pr-6 text-sm mb-1">${conv.title || 'æ–°å¯¹è¯'}</div>
                        <div class="text-xs text-gray-400">${new Date(conv.modified).toLocaleString()}</div>
                        <div class="absolute top-0 bottom-0 left-0 w-1 bg-blue-500 rounded-l-lg opacity-0 group-hover:opacity-100 transition"></div>
                    </div>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }

        async function loadConversation(conversationId) {
            // 1. æ›´æ–°å…¨å±€çŠ¶æ€
            currentConversationId = conversationId;
            const container = document.getElementById('messagesContainer');

            // 2. æ˜¾ç¤ºåŠ è½½åŠ¨ç”» (æ¸…ç©ºå½“å‰å±å¹•)
            container.innerHTML = '<div class="h-full flex flex-col items-center justify-center text-gray-400"><i class="fas fa-spinner fa-spin text-3xl mb-4"></i><p>æ­£åœ¨æ¢å¤è®°å¿†...</p></div>';

            // 3. åˆ·æ–°ä¾§è¾¹æ çŠ¶æ€ (ç§»åŠ¨ç«¯è‡ªåŠ¨æ”¶èµ·)
            loadHistory();
            if (window.innerWidth < 768) document.getElementById('historySidebar').classList.add('hidden');

            try {
                // 4. è¯·æ±‚åç«¯æ¥å£
                const res = await fetch(`${API_BASE}/v1/conversations/${conversationId}/history`);
                const messages = await res.json();

                container.innerHTML = ''; // æ¸…é™¤åŠ è½½åŠ¨ç”»

                if (messages.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-12">è¯¥ä¼šè¯æš‚æ— æ¶ˆæ¯</div>';
                    return;
                }

                // --- 5. æ¶ˆæ¯æ¸²æŸ“å¾ªç¯ (å…³é”®é€»è¾‘) ---
                let lastUserContent = null;

                messages.forEach(msg => {
                    // A. ç”¨æˆ·æ¶ˆæ¯å»é‡é€»è¾‘
                    // (é˜²æ­¢å› ä¸º Fan-out åˆ†å‘å¯¼è‡´æ•°æ®åº“é‡Œå­˜äº†å¤šæ¡é‡å¤çš„ç”¨æˆ·æé—®)
                    if (msg.role === 'user') {
                        if (msg.content === lastUserContent) {
                            return; // è·³è¿‡é‡å¤æ¶ˆæ¯
                        }
                        lastUserContent = msg.content;
                    }

                    // B. åŠ©æ‰‹æ¶ˆæ¯å¤„ç†
                    if (msg.role === 'assistant') {
                        // æƒ…å†µ 1: è¿™æ˜¯ä¸€ä¸ªæ­£åœ¨ç”Ÿæˆçš„ä»»åŠ¡ (å¦‚æœä½ ä¿®æ”¹äº†åç«¯è¿”å› PENDING çŠ¶æ€)
                        if (msg.is_loading) {
                            addMessage('assistant', '<div class="typing-indicator flex gap-1"><span>â—</span><span>â—</span><span>â—</span></div>', true);
                            return;
                        }

                        // æƒ…å†µ 2: æ­£å¸¸çš„å·²å®Œæˆæ¶ˆæ¯
                        let content = msg.content;
                        if (msg.model) {
                            content = `**ğŸ¤– ${msg.model}**:\n\n${content}`;
                        }
                        addMessage('assistant', content);
                    }
                    // C. ç”¨æˆ·æˆ–ç³»ç»Ÿæ¶ˆæ¯ç›´æ¥æ˜¾ç¤º
                    else {
                        addMessage(msg.role, msg.content);
                    }
                });

                // 6. æ»šåŠ¨åˆ°åº•éƒ¨
                setTimeout(() => container.scrollTop = container.scrollHeight, 100);

            } catch (e) {
                console.error(e);
                container.innerHTML = ''; // æ¸…ç©ºå¯èƒ½çš„åŠ è½½æ®‹ç•™
                addMessage('error', `âŒ åŠ è½½å¤±è´¥: ${e.message}`);
            }
        }

// === UI è¾…åŠ©å‡½æ•° (ä¿®å¤ç‰ˆï¼šè¿”å›å”¯ä¸€ ID) ===
        function addMessage(role, content, isLoading = false) {
            const container = document.getElementById('messagesContainer');
            // ç§»é™¤åŸæœ¬çš„â€œå¼€å§‹æ–°å¯¹è¯â€æ¬¢è¿ç•Œé¢
            if (container.querySelector('.h-full')) container.querySelector('.h-full').remove();

            const div = document.createElement('div');

            // ğŸ”¥ æ ¸å¿ƒä¿®å¤ 1: ç”Ÿæˆå…¨çƒå”¯ä¸€çš„ ID
            // æ ¼å¼: msg-æ—¶é—´æˆ³-éšæœºæ•° (ä¾‹å¦‚: msg-1738001234567-x8z9a2)
            const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            div.id = messageId; // æŠŠ ID èµ‹ç»™ DOM å…ƒç´ 

            const isUser = role === 'user';

            div.className = `message-enter flex w-full ${isUser ? 'justify-end' : 'justify-start'}`;

            const avatarHtml = isUser ?
                `<div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center flex-shrink-0 text-white ml-2"><i class="fas fa-user"></i></div>` :
                `<div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0 text-white mr-2"><i class="fas fa-robot"></i></div>`;

            const errorClass = role === 'error' ? 'bg-red-50 border border-red-200 text-red-800' : '';
            const bgClass = isUser ? 'bg-blue-600 text-white rounded-br-none' : `bg-white border border-gray-200 text-gray-800 rounded-bl-none ${errorClass}`;

            const contentHtml = isLoading ? content : marked.parse(content);

            div.innerHTML = `
                <div class="flex max-w-[85%] md:max-w-[75%] ${isUser ? 'flex-row-reverse' : 'flex-row'} items-start">
                    ${avatarHtml}
                    <div class="${bgClass} px-4 py-3 rounded-2xl shadow-sm text-sm overflow-hidden">
                        <div class="markdown-body ${isUser ? 'text-white' : ''}">
                            ${contentHtml}
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;

            // ğŸ”¥ æ ¸å¿ƒä¿®å¤ 2: è¿”å›å­—ç¬¦ä¸² IDï¼Œè€Œä¸æ˜¯ div å¯¹è±¡
            // è¿™æ · pollBatchResult é‡Œçš„ document.getElementById(loadingId) æ‰èƒ½å·¥ä½œ
            return messageId;
        }

        function newChat() {
            currentConversationId = null;
            document.getElementById('messagesContainer').innerHTML = `<div class="h-full flex flex-col items-center justify-center text-gray-400"><i class="fas fa-comments text-4xl text-gray-300 mb-6"></i><h2 class="text-xl font-semibold mb-2">å¼€å§‹æ–°çš„å¯¹è¯</h2></div>`;
            document.getElementById('messageInput').focus();
            loadHistory();
        }

        async function checkHealth() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                if (data.status === 'ok') document.getElementById('statusIndicator').innerHTML = `<span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span> System Online`;
            } catch (e) {
                document.getElementById('statusIndicator').innerHTML = `<span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span> Offline`;
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            const preview = document.getElementById('filePreview');
            if (files.length > 0) {
                preview.classList.remove('hidden');
                preview.innerHTML = files.map(f => `<div class="flex items-center gap-2 bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs border border-blue-100"><i class="fas fa-file"></i> ${f.name}</div>`).join('');
            } else { preview.classList.add('hidden'); }
        }
    </script>
</body>
</html>