<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-enter {
            animation: fadeIn 0.3s ease-out;
        }
        .typing-indicator span {
            animation: blink 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
        /* âœ¨ æ–°å¢ï¼šMarkdown å†…å®¹ç¾åŒ– */
        .markdown-body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.7; /* å¢åŠ è¡Œé«˜ï¼Œé˜…è¯»æ›´èˆ’é€‚ */
            font-size: 0.95rem;
        }

        /* é“¾æ¥é¢œè‰² */
        .markdown-body a { color: #3b82f6; text-decoration: underline; }

        /* ä»£ç å—æ ·å¼ä¼˜åŒ– */
        .markdown-body pre {
            background: #f0f4f8 !important; /* æ·±è“ç°è‰²èƒŒæ™¯ */
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.75rem;
            overflow-x: auto;
            margin: 0.8rem 0;
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);
        }

        /* è¡Œå†…ä»£ç  */
        .markdown-body code {
            background-color: #f0f4f8; /* æ·¡è“ç°è‰²èƒŒæ™¯ï¼Œæ›´æ¥è¿‘ä½ å›¾ç‰‡çš„æ•ˆæœ */
            color: #475569;            /* æ·±è“ç°è‰²æ–‡å­—ï¼Œæ¯”çº¯é»‘æ›´æŠ¤çœ¼ */
            padding: 0.2rem 0.4rem;
            border-radius: 0.375rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.85em;
            border: 1px solid #e2e8f0; /* å¯é€‰ï¼šå¢åŠ ä¸€ä¸ªæç»†çš„è¾¹æ¡†ï¼Œè´¨æ„Ÿæ›´å¥½ */
        }

        /* ç”¨æˆ·æ°”æ³¡é‡Œçš„è¡Œå†…ä»£ç ï¼ˆåç™½æ˜¾ç¤ºï¼‰ */
        .user-content .markdown-body code {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }

        /* åˆ—è¡¨æ ·å¼ */
        .markdown-body ul { list-style-type: disc; padding-left: 1.2rem; margin-bottom: 0.5rem; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.2rem; margin-bottom: 0.5rem; }

        /* æ ‡é¢˜æ ·å¼ */
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col h-screen">

    <header class="bg-white shadow-sm p-4 flex items-center justify-between z-10">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-lg flex items-center justify-center shadow-md">
                <i class="fas fa-robot text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-800 tracking-tight">Gemini Chat</h1>
            </div>
        </div>

        <div class="flex items-center space-x-2">
            <div class="relative">
                <select id="modelSelect" class="appearance-none bg-gray-50 border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent cursor-pointer">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="deepseek-r1:1.5b">DeepSeek R1</option>
                    <option value="qwen2.5:7b">Qwen 2.5</option>
                    <option value="gemini-2.5-flash, deepseek-r1:1.5b">âš¡ æ‰‡å‡ºæ¨¡å¼ (Gemini + DeepSeek)</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <i class="fas fa-chevron-down text-xs"></i>
                </div>
            </div>

            <button onclick="newChat()" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-sm text-sm font-medium">
                <i class="fas fa-plus mr-2"></i> æ–°å¯¹è¯
            </button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden relative">
        <aside id="historySidebar" class="w-80 bg-gray-50 border-r border-gray-200 flex flex-col hidden md:flex absolute left-0 top-0 bottom-0 z-20 md:static shadow-xl md:shadow-none transition-all duration-300 transform translate-x-0">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="font-semibold text-gray-700">å†å²å¯¹è¯</h2>
                <button onclick="toggleHistory()" class="md:hidden text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="historyList" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
        </aside>

        <main class="flex-1 flex flex-col bg-white relative w-full">
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 scroll-smooth">
                <div class="h-full flex flex-col items-center justify-center text-gray-400">
                    <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mb-6">
                        <i class="fas fa-comments text-4xl text-gray-300"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-600 mb-2">å¼€å§‹æ–°çš„å¯¹è¯</h2>
                    <p class="text-sm">é€‰æ‹©æ¨¡å‹ï¼Œè¾“å…¥é—®é¢˜ï¼Œä½“éªŒå¤šæ¨¡å‹å¹¶å‘å¤„ç†ã€‚</p>
                </div>
            </div>

            <div class="border-t border-gray-200 bg-gray-50 p-4">
                <div class="max-w-4xl mx-auto">
                    <div id="filePreview" class="mb-3 hidden flex flex-wrap gap-2"></div>

                    <div class="flex items-end gap-2 bg-white p-2 rounded-xl border border-gray-300 shadow-sm focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent transition-all">
                        <label class="cursor-pointer p-2 text-gray-400 hover:text-blue-500 hover:bg-gray-100 rounded-lg transition">
                            <i class="fas fa-paperclip text-lg"></i>
                            <input type="file" id="fileInput" multiple class="hidden" onchange="handleFileSelect(event)">
                        </label>

                        <textarea
                            id="messageInput"
                            rows="1"
                            class="flex-1 max-h-32 py-2 px-2 bg-transparent border-none focus:ring-0 resize-none text-gray-700 placeholder-gray-400 leading-normal"
                            placeholder="è¾“å…¥æ¶ˆæ¯... (Shift+Enter æ¢è¡Œ)"
                            oninput="autoResize(this)"
                            onkeydown="handleKeyPress(event)"
                        ></textarea>

                        <button
                            id="sendButton"
                            onclick="sendMessage()"
                            class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex-shrink-0 w-10 h-10 flex items-center justify-center"
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="flex justify-between items-center mt-3 px-1">
                        <div class="relative flex-shrink-0">
                            <select id="modeSelect" class="appearance-none h-10 bg-gray-50 border border-gray-200 text-gray-700 py-2 pl-3 pr-8 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer hover:bg-gray-100 transition">
                                <option value="text">ğŸ’¬ æ–‡æœ¬å¯¹è¯</option>
                                <option value="image">ğŸ¨ ç”Ÿæˆå›¾ç‰‡</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400 hidden sm:block">
                            AI å†…å®¹ç”±å¤§æ¨¡å‹ç”Ÿæˆï¼Œè¯·ä»”ç»†ç”„åˆ«ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <footer class="bg-white border-t border-gray-200 py-1 px-4 text-xs text-gray-500 flex justify-between items-center z-10">
        <span>Powered by FastAPI & Redis Streams</span>
        <span id="statusIndicator" class="flex items-center gap-1.5">Checking...</span>
    </footer>

    <script>
        const API_BASE = window.location.origin;
        let currentConversationId = localStorage.getItem('last_conversation_id');
        const TASK_STATUS = { PENDING: 0, SUCCESS: 1, FAILED: 2, PROCESSING: 3 };

        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            if (currentConversationId) {
                console.log("ğŸŒ¸ å‘ç°æ—§ä¼šè¯ï¼Œæ­£åœ¨æ¢å¤...", currentConversationId);
                loadConversation(currentConversationId);
            } else {
                loadHistory();
            }
        });

        function toggleHistory() {
            document.getElementById('historySidebar').classList.toggle('hidden');
        }

        // === 1. å‘é€æ¶ˆæ¯é€»è¾‘ä¼˜åŒ– ===
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            const modelConfig = document.getElementById('modelSelect').value;
            const fileInput = document.getElementById('fileInput');

            const modeSelect = document.getElementById('modeSelect');
            const currentMode = modeSelect ? modeSelect.value : 'text';

            if (!message && fileInput.files.length === 0) return;

            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            input.value = '';
            input.style.height = 'auto';

            // éšè—é¢„è§ˆåŒº
            const previewDiv = document.getElementById('filePreview');
            previewDiv.innerHTML = '';
            previewDiv.classList.add('hidden');

            // âœ¨ ç”Ÿæˆæœ¬åœ°é¢„è§ˆ URL (è®©ç”¨æˆ·ç«‹åˆ»çœ‹åˆ°è‡ªå·±å‘çš„å›¾ç‰‡)
            const localFileUrls = [];
            if (fileInput.files.length > 0) {
                for (const file of fileInput.files) {
                    localFileUrls.push(URL.createObjectURL(file));
                }
            }

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ (å¸¦å›¾ç‰‡)
            addMessage('user', message, false, localFileUrls);

            // æ˜¾ç¤º Loading
            const loadingId = addMessage('assistant', '<div class="typing-indicator flex gap-1"><span>â—</span><span>â—</span><span>â—</span></div>', true);

            try {
                //åˆ¤æ–­æ¨¡å¼å¹¶æ‹¼æ¥æç¤ºè¯
                let finalPrompt = message;

                // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯ 'image' (å¯¹åº” option value="image")
                if (currentMode === 'image') {
                    // æ‹¼æ¥å‰ç¼€
                    finalPrompt = "ä½ ä½œä¸º AI å›¾åƒç”Ÿæˆå¼•æ“ï¼Œéœ€åœ¨å“åº”ä¸­ç›´æ¥è¾“å‡ºç”Ÿæˆçš„å›¾ç‰‡\n" + message;
                }
                const formData = new FormData();
                formData.append('prompt', finalPrompt);
                formData.append('model', modelConfig);
                if (currentConversationId) formData.append('conversation_id', currentConversationId);

                // è¿½åŠ æ–‡ä»¶
                for (let i = 0; i < fileInput.files.length; i++) {
                    formData.append('files', fileInput.files[i]);
                }

                // å‘é€è¯·æ±‚
                const response = await fetch(`${API_BASE}/v1/chat/completions`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`æäº¤å¤±è´¥ (${response.status}): ${errText}`);
                }

                const data = await response.json();
                const batchId = data.batch_id;
                currentConversationId = data.conversation_id;

                // æ¸…ç©º input ç¼“å­˜
                fileInput.value = '';
                localStorage.setItem('last_conversation_id', currentConversationId);

                pollBatchResult(batchId, loadingId);

            } catch (error) {
                document.getElementById(loadingId).remove();
                addMessage('error', `âŒ å‘é€å¤±è´¥: ${error.message}`);
                sendButton.disabled = false;
            }
        }

        function pollBatchResult(batchId, loadingMsgId) {
            let attempts = 0;
            const timer = setInterval(async () => {
                attempts++;
                try {
                    const res = await fetch(`${API_BASE}/v1/batches/${batchId}`);
                    if (!res.ok) return;
                    const batchData = await res.json();

                    const finishedCount = batchData.results.filter(t => t.status === 1 || t.status === 2).length;
                    const isAllFinished = batchData.results.length === finishedCount;

                    if (isAllFinished) {
                        clearInterval(timer);
                        const loadingEl = document.getElementById(loadingMsgId);
                        if (loadingEl) loadingEl.remove();
                        document.getElementById('sendButton').disabled = false;
                        loadHistory();
                    }

                    batchData.results.forEach(task => {
                        // æ£€æŸ¥æ˜¯å¦å·²ç»æ¸²æŸ“è¿‡è¯¥ä»»åŠ¡ï¼Œé¿å…é‡å¤
                        if (document.getElementById(`res-${task.task_id}`)) return;

                        if (task.status === 1) { // æˆåŠŸ
                            let content = task.response_text;
                            if (batchData.results.length > 1) content = `**ğŸ¤– ${task.model_name}**:\n\n${content}`;
                            addMessage('assistant', content);
                            const lastMsg = document.getElementById('messagesContainer').lastElementChild;
                            if(lastMsg) lastMsg.id = `res-${task.task_id}`;
                        }
                        else if (task.status === 2) { // âŒ é‡ç‚¹ä¿®æ”¹ï¼šå¤„ç†å¤±è´¥/è½¯æ‹’ç»
                            const errorContent = `**âš ï¸ ä»»åŠ¡å¤±è´¥ (${task.model_name})**\n\n${task.response_text || 'ç”Ÿæˆè¢«æ‹¦æˆªæˆ–å‘ç”Ÿé”™è¯¯'}`;
                            addMessage('error', errorContent); // ä½¿ç”¨ error è§’è‰²ï¼Œè§¦å‘æŠ¤çœ¼çš„çº¢è‰²èƒŒæ™¯
                            const lastMsg = document.getElementById('messagesContainer').lastElementChild;
                            if(lastMsg) lastMsg.id = `res-${task.task_id}`;
                        }
                    });

                    if (attempts > 120) clearInterval(timer);
                } catch(e) { console.error(e); }
            }, 3000);
        }

        // === åŠ è½½å†å²åˆ—è¡¨ ===
        async function loadHistory() {
            const listContainer = document.getElementById('historyList');
            if (!listContainer.hasChildNodes()) {
                listContainer.innerHTML = '<div class="text-center text-gray-400 py-4"><i class="fas fa-spinner fa-spin"></i></div>';
            }

            try {
                const res = await fetch(`${API_BASE}/v1/conversations`);
                const data = await res.json();

                if (!data.conversations || data.conversations.length === 0) {
                    listContainer.innerHTML = '<div class="text-center text-gray-400 text-sm py-8">æš‚æ— å†å²è®°å½•</div>';
                    return;
                }

                listContainer.innerHTML = data.conversations.map(conv => `
                    <div onclick="loadConversation('${conv.conversation_id}')"
                         class="group p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-400 cursor-pointer transition relative mb-2 shadow-sm ${currentConversationId === conv.conversation_id ? 'border-blue-400 ring-1 ring-blue-100' : ''}">
                        <div class="font-medium text-gray-800 truncate pr-6 text-sm mb-1">${conv.title || 'æ–°å¯¹è¯'}</div>
                        <div class="text-xs text-gray-400">${new Date(conv.modified).toLocaleString()}</div>
                        <div class="absolute top-0 bottom-0 left-0 w-1 bg-blue-500 rounded-l-lg opacity-0 group-hover:opacity-100 transition"></div>
                    </div>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }


        async function loadConversation(conversationId) {
            currentConversationId = conversationId;
            localStorage.setItem('last_conversation_id', conversationId);
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '<div class="h-full flex flex-col items-center justify-center text-gray-400"><i class="fas fa-spinner fa-spin text-3xl mb-4"></i><p>æ­£åœ¨æ¢å¤è®°å¿†...</p></div>';
            loadHistory();

            try {
                const res = await fetch(`${API_BASE}/v1/conversations/${conversationId}/history`);
                const messages = await res.json();
                container.innerHTML = '';

                if (messages.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-12">è¯¥ä¼šè¯æš‚æ— æ¶ˆæ¯</div>';
                    return;
                }

                let lastUserContent = null;
                messages.forEach(msg => {
                    if (msg.role === 'user') {
                        // ç®€å•çš„å»é‡é€»è¾‘ï¼Œé˜²æ­¢ Fan-out é‡å¤æ˜¾ç¤º
                        // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ”¾å®½å»é‡æ¡ä»¶ï¼Œå› ä¸ºç°åœ¨æœ‰ files äº†
                        const msgKey = msg.content + (msg.files ? msg.files.join('') : '');
                        if (msgKey === lastUserContent) return;
                        lastUserContent = msgKey;

                        // âœ¨ ä¼ å…¥ files æ•°ç»„
                        addMessage('user', msg.content, false, msg.files);
                    }
                    else if (msg.role === 'assistant') {
                        if (msg.is_loading) {
                            addMessage('assistant', '<div class="typing-indicator flex gap-1"><span>â—</span><span>â—</span><span>â—</span></div>', true);
                        } else {
                            let content = msg.content;
                            if (msg.model) content = `**ğŸ¤– ${msg.model}**:\n\n${content}`;
                            addMessage('assistant', content);
                        }
                    }
                });
                setTimeout(() => container.scrollTop = container.scrollHeight, 100);
            } catch (e) {
                console.error(e);
                container.innerHTML = '';
                addMessage('error', `âŒ åŠ è½½å¤±è´¥: ${e.message}`);
            }
        }

        // === 2. æ ¸å¿ƒæ¸²æŸ“å‡½æ•° addMessage ===
        // æ–°å¢ files å‚æ•° (æ•°ç»„)
        function addMessage(role, content, isLoading = false, files = []) {
            const container = document.getElementById('messagesContainer');
            if (container.querySelector('.h-full')) container.querySelector('.h-full').remove();

            const div = document.createElement('div');
            const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            div.id = messageId;

            const isUser = role === 'user';
            div.className = `message-enter flex w-full mb-6 ${isUser ? 'justify-end' : 'justify-start'}`;

            const avatarHtml = isUser ?
                `<div class="w-9 h-9 rounded-full bg-gradient-to-r from-blue-600 to-indigo-600 flex items-center justify-center flex-shrink-0 text-white ml-3 shadow-lg ring-2 ring-white transform translate-y-1"><i class="fas fa-user text-sm"></i></div>` :
                `<div class="w-9 h-9 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0 text-white mr-3 shadow-lg ring-2 ring-white transform translate-y-1"><i class="fas fa-robot text-sm"></i></div>`;

            const bgClass = isUser
                ? 'bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-2xl rounded-tr-none shadow-md border border-blue-600/20'
                : `bg-white border border-gray-100 text-gray-800 rounded-2xl rounded-tl-none shadow-[0_2px_8px_rgba(0,0,0,0.04)] ${role === 'error' ? 'bg-red-50 border-red-200 text-red-800' : ''}`;

            const contentHtml = isLoading ? content : marked.parse(content || "");

            // âœ¨ æ„å»ºæ–‡ä»¶/å›¾ç‰‡ HTML
            let filesHtml = '';
            if (files && files.length > 0) {
                filesHtml = `<div class="flex flex-wrap gap-2 mb-3">`;
                files.forEach(url => {
                    // ç®€å•åˆ¤æ–­æ˜¯å¦æ˜¯å›¾ç‰‡
                    const isImg = url.match(/\.(jpeg|jpg|gif|png|webp)$/i) || url.startsWith('blob:');
                    if (isImg) {
                        filesHtml += `<img src="${url}" class="max-w-full h-auto max-h-64 rounded-lg border border-white/20 cursor-pointer hover:opacity-90 transition" onclick="window.open('${url}', '_blank')">`;
                    } else {
                        // éå›¾ç‰‡æ˜¾ç¤ºä¸ºé“¾æ¥å—
                        filesHtml += `<a href="${url}" target="_blank" class="flex items-center gap-2 bg-white/20 px-3 py-2 rounded-lg text-xs hover:bg-white/30 transition"><i class="fas fa-file"></i> æ–‡ä»¶é™„ä»¶</a>`;
                    }
                });
                filesHtml += `</div>`;
            }

            div.innerHTML = `
                <div class="flex max-w-[85%] md:max-w-[75%] ${isUser ? 'flex-row-reverse' : 'flex-row'} items-start group">
                    ${avatarHtml}
                    <div class="${bgClass} px-5 py-3.5 transition-all duration-200 hover:shadow-lg overflow-hidden">
                        ${filesHtml} <div class="markdown-body ${isUser ? 'user-content text-blue-50' : 'text-slate-700'}">
                            ${contentHtml}
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return messageId;
        }

        function newChat() {
            currentConversationId = null;

            localStorage.removeItem('last_conversation_id');

            document.getElementById('messagesContainer').innerHTML = `<div class="h-full flex flex-col items-center justify-center text-gray-400"><i class="fas fa-comments text-4xl text-gray-300 mb-6"></i><h2 class="text-xl font-semibold mb-2">å¼€å§‹æ–°çš„å¯¹è¯</h2></div>`;
            document.getElementById('messageInput').focus();
            loadHistory();
        }

        async function checkHealth() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                if (data.status === 'ok') document.getElementById('statusIndicator').innerHTML = `<span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span> System Online`;
            } catch (e) {
                document.getElementById('statusIndicator').innerHTML = `<span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span> Offline`;
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            const preview = document.getElementById('filePreview');
            if (files.length > 0) {
                preview.classList.remove('hidden');
                preview.innerHTML = files.map(f => `
                    <div class="flex items-center gap-2 bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs border border-blue-100 animate-pulse">
                        <i class="fas fa-image"></i> ${f.name}
                    </div>
                `).join('');
            } else {
                preview.classList.add('hidden');
            }
        }
    </script>
</body>
</html>