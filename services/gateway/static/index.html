<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-enter {
            animation: fadeIn 0.3s ease-out;
        }
        .typing-indicator span {
            animation: blink 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
        /* âœ¨ æ–°å¢ï¼šMarkdown å†…å®¹ç¾åŒ– */
        .markdown-body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.7;
            font-size: 0.95rem;
        }
        .markdown-body a { color: #3b82f6; text-decoration: underline; }
        .markdown-body pre {
            background: #f0f4f8 !important;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.75rem;
            overflow-x: auto;
            margin: 0.8rem 0;
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);
        }
        .markdown-body code {
            background-color: #f0f4f8;
            color: #475569;
            padding: 0.2rem 0.4rem;
            border-radius: 0.375rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.85em;
            border: 1px solid #e2e8f0;
        }
        .user-content .markdown-body code {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }
        .markdown-body ul { list-style-type: disc; padding-left: 1.2rem; margin-bottom: 0.5rem; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.2rem; margin-bottom: 0.5rem; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col h-screen">

    <header class="bg-white shadow-sm p-4 flex items-center justify-between z-10">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-lg flex items-center justify-center shadow-md">
                <i class="fas fa-robot text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-800 tracking-tight">Gemini Chat</h1>
            </div>
        </div>

        <div class="flex items-center space-x-2">
            <div class="relative" id="modelSelector">
                <button id="modelMenuBtn" onclick="toggleModelMenu()" class="flex items-center justify-between min-w-[160px] bg-gray-50 border border-gray-300 text-gray-700 py-2 px-4 rounded-lg text-sm hover:bg-gray-100 transition focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <span id="modelBtnText" class="truncate max-w-[140px]">Gemini 2.5 Flash</span>
                    <i class="fas fa-chevron-down text-xs ml-2 text-gray-500"></i>
                </button>

                <div id="modelMenu" class="hidden absolute top-full right-0 mt-2 w-64 bg-white border border-gray-200 rounded-xl shadow-2xl z-50 p-1 transform origin-top-right transition-all duration-200 opacity-0 scale-95">
                    <div class="p-2 border-b border-gray-100 mb-1">
                        <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">é€‰æ‹©æ¨¡å‹ (æ”¯æŒå¹¶å‘)</p>
                    </div>

                    <div class="flex items-center justify-between p-2 hover:bg-blue-50 rounded-lg transition group">

                        <label class="flex items-center cursor-pointer flex-1 min-w-0">
                            <input type="checkbox" value="gemini-2.5-flash" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 transition" onchange="updateModelSelection()">
                            <div class="ml-3 flex flex-col overflow-hidden">
                                <span class="text-sm font-medium text-gray-700 group-hover:text-blue-700 truncate">Gemini 2.5 Flash</span>
                                <span class="text-[10px] text-gray-400 truncate">Google é«˜é€Ÿæ¨¡å‹</span>
                            </div>
                        </label>

                        <div class="flex items-center ml-2 pl-2 border-l border-gray-200" title="å¼€å¯åŒèŠ‚ç‚¹å¹¶å‘ (x2)">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="geminiDualMode" class="sr-only peer">

                                <div class="w-8 h-4 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-blue-600"></div>

                                <span class="ml-1 text-[10px] font-bold text-gray-400 peer-checked:text-blue-600 select-none">x2</span>
                            </label>
                        </div>

                    </div>


                    <label class="flex items-center p-2.5 hover:bg-blue-50 rounded-lg cursor-pointer transition group">
                        <input type="checkbox" value="deepseek-r1:1.5b" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 transition" onchange="updateModelSelection()">
                         <div class="ml-3 flex flex-col">
                            <span class="text-sm font-medium text-gray-700 group-hover:text-blue-700">DeepSeek R1</span>
                            <span class="text-[10px] text-gray-400">æ·±åº¦æ¨ç†æ¨¡å‹</span>
                        </div>
                    </label>

                    <label class="flex items-center p-2.5 hover:bg-blue-50 rounded-lg cursor-pointer transition group">
                        <input type="checkbox" value="qwen3:8b" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 transition" onchange="updateModelSelection()">
                         <div class="ml-3 flex flex-col">
                            <span class="text-sm font-medium text-gray-700 group-hover:text-blue-700">Qwen 3</span>
                            <span class="text-[10px] text-gray-400">é€šä¹‰åƒé—®å¼€æºç‰ˆ</span>
                        </div>
                    </label>
                </div>
            </div>
            <button onclick="newChat()" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-sm text-sm font-medium">
                <i class="fas fa-plus mr-2"></i> æ–°å¯¹è¯
            </button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden relative">
        <aside id="historySidebar" class="w-80 bg-gray-50 border-r border-gray-200 flex flex-col hidden md:flex absolute left-0 top-0 bottom-0 z-20 md:static shadow-xl md:shadow-none transition-all duration-300 transform translate-x-0">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="font-semibold text-gray-700">å†å²å¯¹è¯</h2>
                <button onclick="toggleHistory()" class="md:hidden text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="historyList" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
        </aside>

        <main class="flex-1 flex flex-col bg-white relative w-full">
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 scroll-smooth">
                <div class="h-full flex flex-col items-center justify-center text-gray-400">
                    <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mb-6">
                        <i class="fas fa-comments text-4xl text-gray-300"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-600 mb-2">å¼€å§‹æ–°çš„å¯¹è¯</h2>
                    <p class="text-sm">é€‰æ‹©æ¨¡å‹ï¼Œè¾“å…¥é—®é¢˜ï¼Œä½“éªŒå¤šæ¨¡å‹å¹¶å‘å¤„ç†ã€‚</p>
                </div>
            </div>

            <div class="border-t border-gray-200 bg-gray-50 p-4">
                <div class="max-w-4xl mx-auto">
                    <div id="filePreview" class="mb-3 hidden flex flex-wrap gap-2"></div>

                    <div class="flex items-end gap-2 bg-white p-2 rounded-xl border border-gray-300 shadow-sm focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent transition-all">
                        <label class="cursor-pointer p-2 text-gray-400 hover:text-blue-500 hover:bg-gray-100 rounded-lg transition">
                            <i class="fas fa-paperclip text-lg"></i>
                            <input type="file" id="fileInput" multiple class="hidden" onchange="handleFileSelect(event)">
                        </label>

                        <textarea
                            id="messageInput"
                            rows="1"
                            class="flex-1 max-h-32 py-2 px-2 bg-transparent border-none focus:ring-0 resize-none text-gray-700 placeholder-gray-400 leading-normal"
                            placeholder="è¾“å…¥æ¶ˆæ¯... (Shift+Enter æ¢è¡Œ)"
                            oninput="autoResize(this)"
                            onkeydown="handleKeyPress(event)"
                        ></textarea>

                        <button
                            id="sendButton"
                            onclick="sendMessage()"
                            class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex-shrink-0 w-10 h-10 flex items-center justify-center"
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="flex justify-between items-center mt-3 px-1">
                        <div class="relative flex-shrink-0">
                            <select id="modeSelect" class="appearance-none h-10 bg-gray-50 border border-gray-200 text-gray-700 py-2 pl-3 pr-8 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer hover:bg-gray-100 transition">
                                <option value="text">ğŸ’¬ æ–‡æœ¬å¯¹è¯</option>
                                <option value="image">ğŸ¨ ç”Ÿæˆå›¾ç‰‡</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400 hidden sm:block">
                            AI å†…å®¹ç”±å¤§æ¨¡å‹ç”Ÿæˆï¼Œè¯·ä»”ç»†ç”„åˆ«ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <footer class="bg-white border-t border-gray-200 py-1 px-4 text-xs text-gray-500 flex justify-between items-center z-10">
        <span>Powered by FastAPI & Redis Streams</span>
        <span id="statusIndicator" class="flex items-center gap-1.5">Checking...</span>
    </footer>

    <script>
        const API_BASE = window.location.origin;
        let currentConversationId = localStorage.getItem('last_conversation_id');
        const TASK_STATUS = { PENDING: 0, SUCCESS: 1, FAILED: 2, PROCESSING: 3 };

        // === ä¸‹æ‹‰èœå•é€»è¾‘ ===
        function toggleModelMenu() {
            const menu = document.getElementById('modelMenu');
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                setTimeout(() => {
                    menu.classList.remove('opacity-0', 'scale-95');
                    menu.classList.add('opacity-100', 'scale-100');
                }, 10);
            } else {
                closeModelMenu();
            }
        }

        function closeModelMenu() {
            const menu = document.getElementById('modelMenu');
            menu.classList.remove('opacity-100', 'scale-100');
            menu.classList.add('opacity-0', 'scale-95');
            setTimeout(() => menu.classList.add('hidden'), 200);
        }

        function updateModelSelection() {
            const checkboxes = document.querySelectorAll('#modelMenu input[type="checkbox"]:checked');
            const btnText = document.getElementById('modelBtnText');

            if (checkboxes.length === 0) {
                btnText.textContent = "è¯·é€‰æ‹©æ¨¡å‹";
                btnText.classList.add('text-red-500');
            } else if (checkboxes.length === 1) {
                // å¦‚æœåªé€‰äº†ä¸€ä¸ªï¼Œæ˜¾ç¤ºå…·ä½“çš„åç§°
                const label = checkboxes[0].nextElementSibling.querySelector('span').textContent;
                btnText.textContent = label;
                btnText.classList.remove('text-red-500');
            } else {
                btnText.textContent = `å·²é€‰ ${checkboxes.length} ä¸ªæ¨¡å‹ (å¹¶å‘)`;
                btnText.classList.remove('text-red-500');
            }
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        window.addEventListener('click', function(e) {
            const menu = document.getElementById('modelMenu');
            const btn = document.getElementById('modelMenuBtn');
            const selector = document.getElementById('modelSelector');
            if (selector && !selector.contains(e.target)) {
                if(!menu.classList.contains('hidden')) closeModelMenu();
            }
        });
        // === ç»“æŸä¸‹æ‹‰èœå•é€»è¾‘ ===

        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            if (currentConversationId) {
                console.log("ğŸŒ¸ å‘ç°æ—§ä¼šè¯ï¼Œæ­£åœ¨æ¢å¤...", currentConversationId);
                loadConversation(currentConversationId);
            } else {
                loadHistory();
            }
        });

        function toggleHistory() {
            document.getElementById('historySidebar').classList.toggle('hidden');
        }

        // === 1. å‘é€æ¶ˆæ¯é€»è¾‘ä¼˜åŒ– ===
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            // âš¡ ä¿®æ”¹ï¼šè·å–é€‰ä¸­çš„æ¨¡å‹åˆ—è¡¨
            const allCheckboxes = document.querySelectorAll('#modelMenu input[type="checkbox"]:checked');
            const modelCheckboxes = Array.from(allCheckboxes).filter(cb => cb.id !== 'geminiDualMode');

            if (modelCheckboxes.length === 0) {
                alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¨¡å‹ï¼");
                return;
            }
            // æ‹¼æ¥æˆé€—å·åˆ†éš”å­—ç¬¦ä¸²: "gemini-2.5-flash, qwen3:8b"
            const modelConfig = modelCheckboxes.map(cb => cb.value).join(', ');

            const fileInput = document.getElementById('fileInput');
            const modeSelect = document.getElementById('modeSelect');
            const currentMode = modeSelect ? modeSelect.value : 'text';

            // âœ¨ è·å– Gemini åŒè·¯å¼€å…³çŠ¶æ€
            const dualModeToggle = document.getElementById('geminiDualMode');
            // å¦‚æœå¼€å…³å­˜åœ¨ä¸”è¢«å‹¾é€‰ï¼Œå¹¶å‘æ•°è®¾ä¸º 2ï¼Œå¦åˆ™ä¸º 1
            const concurrency = (dualModeToggle && dualModeToggle.checked) ? 2 : 1;

            if (!message && fileInput.files.length === 0) return;

            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            input.value = '';
            input.style.height = 'auto';

            // éšè—é¢„è§ˆåŒº
            const previewDiv = document.getElementById('filePreview');
            previewDiv.innerHTML = '';
            previewDiv.classList.add('hidden');

            // âœ¨ ç”Ÿæˆæœ¬åœ°é¢„è§ˆ URL
            const localFileUrls = [];
            if (fileInput.files.length > 0) {
                for (const file of fileInput.files) {
                    localFileUrls.push(URL.createObjectURL(file));
                }
            }

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ (å¸¦å›¾ç‰‡)
            addMessage('user', message, false, localFileUrls);

            // æ˜¾ç¤º Loading
            const loadingId = addMessage('assistant', '<div class="typing-indicator flex gap-1"><span>â—</span><span>â—</span><span>â—</span></div>', true);

            try {

                const formData = new FormData();
                formData.append('prompt', message);
                formData.append('model', modelConfig); // âš¡ ä½¿ç”¨æ–°çš„ config
                formData.append('mode', currentMode);
                formData.append('gemini_concurrency', concurrency);

                if (currentConversationId) formData.append('conversation_id', currentConversationId);

                // è¿½åŠ æ–‡ä»¶
                for (let i = 0; i < fileInput.files.length; i++) {
                    formData.append('files', fileInput.files[i]);
                }

                // å‘é€è¯·æ±‚
                const response = await fetch(`${API_BASE}/v1/chat/completions`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`æäº¤å¤±è´¥ (${response.status}): ${errText}`);
                }

                const data = await response.json();
                const batchId = data.batch_id;
                currentConversationId = data.conversation_id;

                // æ¸…ç©º input ç¼“å­˜
                fileInput.value = '';
                localStorage.setItem('last_conversation_id', currentConversationId);

                pollBatchResult(batchId, loadingId);

            } catch (error) {
                document.getElementById(loadingId).remove();
                addMessage('error', `âŒ å‘é€å¤±è´¥: ${error.message}`);
                sendButton.disabled = false;
            }
        }

        function pollBatchResult(batchId, loadingMsgId) {
            let attempts = 0;
            const timer = setInterval(async () => {
                attempts++;
                try {
                    const res = await fetch(`${API_BASE}/v1/batches/${batchId}`);
                    if (!res.ok) return;
                    const batchData = await res.json();

                    const finishedCount = batchData.results.filter(t => t.status === 1 || t.status === 2).length;
                    const isAllFinished = batchData.results.length === finishedCount;

                    if (isAllFinished) {
                        clearInterval(timer);
                        const loadingEl = document.getElementById(loadingMsgId);
                        if (loadingEl) loadingEl.remove();
                        document.getElementById('sendButton').disabled = false;
                        loadHistory();
                    }

                    batchData.results.forEach(task => {
                        // æ£€æŸ¥æ˜¯å¦å·²ç»æ¸²æŸ“è¿‡è¯¥ä»»åŠ¡ï¼Œé¿å…é‡å¤
                        if (document.getElementById(`res-${task.task_id}`)) return;

                        if (task.status === 1) { // æˆåŠŸ
                            let content = task.response_text;
                            // å¦‚æœæ˜¯å¤šæ¨¡å‹å¹¶å‘ï¼Œæˆ–è€…å³ä½¿æ˜¯å•ä¸ªæ¨¡å‹ï¼Œä¸ºäº†åŒºåˆ†æ˜¯è°è¯´çš„ï¼Œä¹Ÿå¯ä»¥åŠ ä¸Šæ ‡é¢˜
                            // è¿™é‡Œç®€å•åˆ¤æ–­ï¼šå¦‚æœæœ‰å¤šä¸ªä»»åŠ¡ç»“æœï¼Œè‚¯å®šè¦åŠ æ ‡é¢˜
                            if (batchData.results.length > 1) content = `**ğŸ¤– ${task.model_name}**:\n\n${content}`;
                            addMessage('assistant', content);
                            const lastMsg = document.getElementById('messagesContainer').lastElementChild;
                            if(lastMsg) lastMsg.id = `res-${task.task_id}`;
                        }
                        else if (task.status === 2) { // âŒ å¤±è´¥å¤„ç†
                            const errorContent = `**âš ï¸ ä»»åŠ¡å¤±è´¥ (${task.model_name})**\n\n${task.response_text || 'ç”Ÿæˆè¢«æ‹¦æˆªæˆ–å‘ç”Ÿé”™è¯¯'}`;
                            addMessage('error', errorContent);
                            const lastMsg = document.getElementById('messagesContainer').lastElementChild;
                            if(lastMsg) lastMsg.id = `res-${task.task_id}`;
                        }
                    });

                    if (attempts > 120) clearInterval(timer);
                } catch(e) { console.error(e); }
            }, 3000);
        }

        // === åŠ è½½å†å²åˆ—è¡¨ ===
        async function loadHistory() {
            const listContainer = document.getElementById('historyList');
            if (!listContainer.hasChildNodes()) {
                listContainer.innerHTML = '<div class="text-center text-gray-400 py-4"><i class="fas fa-spinner fa-spin"></i></div>';
            }

            try {
                const res = await fetch(`${API_BASE}/v1/conversations`);
                const data = await res.json();

                if (!data.conversations || data.conversations.length === 0) {
                    listContainer.innerHTML = '<div class="text-center text-gray-400 text-sm py-8">æš‚æ— å†å²è®°å½•</div>';
                    return;
                }

                listContainer.innerHTML = data.conversations.map(conv => `
                    <div onclick="loadConversation('${conv.conversation_id}')"
                         class="group p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-400 cursor-pointer transition relative mb-2 shadow-sm ${currentConversationId === conv.conversation_id ? 'border-blue-400 ring-1 ring-blue-100' : ''}">
                        <div class="font-medium text-gray-800 truncate pr-6 text-sm mb-1">${conv.title || 'æ–°å¯¹è¯'}</div>
                        <div class="text-xs text-gray-400">${new Date(conv.modified).toLocaleString()}</div>
                        <div class="absolute top-0 bottom-0 left-0 w-1 bg-blue-500 rounded-l-lg opacity-0 group-hover:opacity-100 transition"></div>
                    </div>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }


        async function loadConversation(conversationId) {
            currentConversationId = conversationId;
            localStorage.setItem('last_conversation_id', conversationId);
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '<div class="h-full flex flex-col items-center justify-center text-gray-400"><i class="fas fa-spinner fa-spin text-3xl mb-4"></i><p>æ­£åœ¨æ¢å¤è®°å¿†...</p></div>';
            loadHistory();

            try {
                const res = await fetch(`${API_BASE}/v1/conversations/${conversationId}/history`);
                const messages = await res.json();
                container.innerHTML = '';

                if (messages.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-12">è¯¥ä¼šè¯æš‚æ— æ¶ˆæ¯</div>';
                    return;
                }

                let lastUserContent = null;
                messages.forEach(msg => {
                    if (msg.role === 'user') {
                        const msgKey = msg.content + (msg.files ? msg.files.join('') : '');
                        if (msgKey === lastUserContent) return;
                        lastUserContent = msgKey;

                        addMessage('user', msg.content, false, msg.files);
                    }
                    else if (msg.role === 'assistant') {
                        if (msg.is_loading) {
                            addMessage('assistant', '<div class="typing-indicator flex gap-1"><span>â—</span><span>â—</span><span>â—</span></div>', true);
                        } else {
                            let content = msg.content;
                            if (msg.model) content = `**ğŸ¤– ${msg.model}**:\n\n${content}`;
                            addMessage('assistant', content);
                        }
                    }
                });
                setTimeout(() => container.scrollTop = container.scrollHeight, 100);
            } catch (e) {
                console.error(e);
                container.innerHTML = '';
                addMessage('error', `âŒ åŠ è½½å¤±è´¥: ${e.message}`);
            }
        }

        // === 2. æ ¸å¿ƒæ¸²æŸ“å‡½æ•° addMessage ===
        function addMessage(role, content, isLoading = false, files = []) {
            const container = document.getElementById('messagesContainer');
            if (container.querySelector('.h-full')) container.querySelector('.h-full').remove();

            const div = document.createElement('div');
            const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            div.id = messageId;

            const isUser = role === 'user';
            div.className = `message-enter flex w-full mb-6 ${isUser ? 'justify-end' : 'justify-start'}`;

            const avatarHtml = isUser ?
                `<div class="w-9 h-9 rounded-full bg-gradient-to-r from-blue-600 to-indigo-600 flex items-center justify-center flex-shrink-0 text-white ml-3 shadow-lg ring-2 ring-white transform translate-y-1"><i class="fas fa-user text-sm"></i></div>` :
                `<div class="w-9 h-9 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0 text-white mr-3 shadow-lg ring-2 ring-white transform translate-y-1"><i class="fas fa-robot text-sm"></i></div>`;

            const bgClass = isUser
                ? 'bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-2xl rounded-tr-none shadow-md border border-blue-600/20'
                : `bg-white border border-gray-100 text-gray-800 rounded-2xl rounded-tl-none shadow-[0_2px_8px_rgba(0,0,0,0.04)] ${role === 'error' ? 'bg-red-50 border-red-200 text-red-800' : ''}`;

            let cleanContent = content;
            if (content && typeof content === 'string') {
                cleanContent = content
                    .replace(/\[cite_start\]/g, "")
                    .replace(/\]+\]/g, "")
                    .replace(/\[cite_end\]/g, "");
            }
            const contentHtml = isLoading ? cleanContent : marked.parse(cleanContent || "");

            // âœ¨ æ„å»ºæ–‡ä»¶/å›¾ç‰‡ HTML
            let filesHtml = '';
            if (files && files.length > 0) {
                filesHtml = `<div class="flex flex-wrap gap-2 mb-3">`;
                files.forEach(url => {
                    const isImg = url.match(/\.(jpeg|jpg|gif|png|webp)$/i) || url.startsWith('blob:');
                    if (isImg) {
                        filesHtml += `<img src="${url}" class="max-w-full h-auto max-h-64 rounded-lg border border-white/20 cursor-pointer hover:opacity-90 transition" onclick="window.open('${url}', '_blank')">`;
                    } else {
                        filesHtml += `<a href="${url}" target="_blank" class="flex items-center gap-2 bg-white/20 px-3 py-2 rounded-lg text-xs hover:bg-white/30 transition"><i class="fas fa-file"></i> æ–‡ä»¶é™„ä»¶</a>`;
                    }
                });
                filesHtml += `</div>`;
            }

            div.innerHTML = `
                <div class="flex max-w-[85%] md:max-w-[75%] ${isUser ? 'flex-row-reverse' : 'flex-row'} items-start group">
                    ${avatarHtml}
                    <div class="${bgClass} px-5 py-3.5 transition-all duration-200 hover:shadow-lg overflow-hidden">
                        ${filesHtml} <div class="markdown-body ${isUser ? 'user-content text-blue-50' : 'text-slate-700'}">
                            ${contentHtml}
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return messageId;
        }

        function newChat() {
            currentConversationId = null;

            localStorage.removeItem('last_conversation_id');

            document.getElementById('messagesContainer').innerHTML = `<div class="h-full flex flex-col items-center justify-center text-gray-400"><i class="fas fa-comments text-4xl text-gray-300 mb-6"></i><h2 class="text-xl font-semibold mb-2">å¼€å§‹æ–°çš„å¯¹è¯</h2></div>`;
            document.getElementById('messageInput').focus();
            loadHistory();
        }

        async function checkHealth() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                if (data.status === 'ok') document.getElementById('statusIndicator').innerHTML = `<span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span> System Online`;
            } catch (e) {
                document.getElementById('statusIndicator').innerHTML = `<span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span> Offline`;
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            const preview = document.getElementById('filePreview');
            if (files.length > 0) {
                preview.classList.remove('hidden');
                preview.innerHTML = files.map(f => `
                    <div class="flex items-center gap-2 bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs border border-blue-100 animate-pulse">
                        <i class="fas fa-image"></i> ${f.name}
                    </div>
                `).join('');
            } else {
                preview.classList.add('hidden');
            }
        }
    </script>
</body>
</html>