version: '3.8'

services:
  redis:
    container_name: redis
    image: redis:7.2-alpine
    restart: always
    ports:
      - "6379:6379"
    environment:
      - TZ=Asia/Shanghai
    command: redis-server --appendonly yes

  api-gateway:
    container_name: gateway
    build:
      context: .
      dockerfile: services/gateway/Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - uploads_cache:/app/services/gateway/uploads
    environment:
      - TZ=Asia/Shanghai
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DB_HOST=postgres
      - DB_PORT=5432
      - POSTGRES_PASSWORD=Hi8899
    depends_on:
      - redis
    deploy:
      replicas: 1

# === Gemini Worker ÊúçÂä° ===
  gemini-worker-1:
    container_name: gemini-worker-1
    build:
      context: .
      dockerfile: services/workers/gemini/Dockerfile
    restart: always
    volumes:
      - uploads_cache:/app/services/gateway/uploads
    environment:
      - TZ=Asia/Shanghai
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DB_HOST=postgres
      - DB_PORT=5432
      - POSTGRES_PASSWORD=Hi8899
      - STREAM_KEY=gemini_stream_1
      - GROUP_NAME=gemini_workers_group_1
      - GEMINI_WORKER_ID=gemini-worker-1
    depends_on:
      - redis

  gemini-worker-2:
    container_name: gemini-worker-2
    build:
      context: .
      dockerfile: services/workers/gemini/Dockerfile
    restart: always
    volumes:
      - uploads_cache:/app/services/gateway/uploads
    environment:
      - TZ=Asia/Shanghai
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DB_HOST=postgres
      - DB_PORT=5432
      - POSTGRES_PASSWORD=Hi8899
      - STREAM_KEY=gemini_stream_1
      - GROUP_NAME=gemini_workers_group_1
      - GEMINI_WORKER_ID=gemini-worker-2
    depends_on:
      - redis

  gemini-worker-3:
      container_name: gemini-worker-3
      build:
        context: .
        dockerfile: services/workers/gemini/Dockerfile
      restart: always
      volumes:
        - uploads_cache:/app/services/gateway/uploads
      environment:
        - TZ=Asia/Shanghai
        - REDIS_HOST=redis
        - REDIS_PORT=6379
        - DB_HOST=postgres
        - DB_PORT=5432
        - POSTGRES_PASSWORD=Hi8899
        # üëá ÂÖ≥ÈîÆ‰øÆÊîπÔºöÁõëÂê¨ gemini_stream_2
        - STREAM_KEY=gemini_stream_2
        - GROUP_NAME=gemini_group_2
        - GEMINI_WORKER_ID=gemini-worker-3
      depends_on:
        - redis

  qwen-worker:
      container_name: qwen-worker
      build:
        context: .
        dockerfile: services/workers/qwen/Dockerfile
      restart: always
      volumes:
        - uploads_cache:/app/services/gateway/uploads
      environment:
        - TZ=Asia/Shanghai
        - REDIS_HOST=redis
        - REDIS_PORT=6379
        - DB_HOST=postgres
        - DB_PORT=5432
        - POSTGRES_PASSWORD=Hi8899
        - STREAM_KEY=qwen_stream
        - GROUP_NAME=qwen_workers_group
        - QWEN_WORKER_ID=qwen-worker-1
        - LLM_SERVICE_URL=http://192.168.202.155:11434/v1/chat/completions
      depends_on:
        - redis

  deepseek-worker:
      container_name: deepseek-worker
      build:
        context: .
        dockerfile: services/workers/deepseek/Dockerfile
      restart: always
      volumes:
        - uploads_cache:/app/services/gateway/uploads
      environment:
        - TZ=Asia/Shanghai
        - REDIS_HOST=redis
        - REDIS_PORT=6379
        - DB_HOST=postgres
        - DB_PORT=5432
        - POSTGRES_PASSWORD=Hi8899
        - STREAM_KEY=deepseek_stream
        - GROUP_NAME=deepseek_workers_group
        - DEEPSEEK_WORKER_ID=deepseek-worker-1
        # üëá ÈÖçÁΩÆ‰∏ãÊ∏∏ LLM Âú∞ÂùÄ (Ollama Êàñ DeepSeek ÂÆòÊñπ)
        - LLM_SERVICE_URL=http://192.168.202.155:11434/v1/chat/completions
        - DEEPSEEK_API_KEY= # Â¶ÇÊûúÊúâ Key ÁöÑËØù
      depends_on:
        - redis

  postgres:
    image: postgres:18
    container_name: postgresql
    ports:
      - "5432:5432"
    environment:
      - TZ=Asia/Shanghai
      - POSTGRES_PASSWORD=Hi8899
      - PGDATA=/var/lib/postgresql/18/docker
      - LANG=C.UTF-8
      - POSTGRES_INITDB_ARGS=-c wal_buffers=16MB
    volumes:
      - pg_data:/var/lib/postgresql/18/docker
    restart: unless-stopped
volumes:
  uploads_cache:
  pg_data:
